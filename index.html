<script>
  // 檢查視窗寬度是否小於 600，如果是就導向 index_mobile.html
  //console.log(screen.width);
  //if (screen.width < 600 && !location.pathname.includes("index_mobile.html")) {
  //  location.href = "index_mobile.html" + location.search;
  //}
</script>
<!DOCTYPE html>
<html lang="en">
<head>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
	<script src="js/svg3DTagCloud.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Swiper CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
	<!-- Swiper JS -->
	<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="css/SystemStyle.css">
	<title>桃園TRPG推廣會系統介紹</title>
</head>
<body>
	<div class="container">
		<!--標題區域-->
		<div class="header-container ">
			<div class="col-lg-12">
				<div class="row d-flex align-items-center">
					<div class="col-md-7 col-12 text-left p-3">
						<a href="https://sleepyknife.github.io/tyntrpg_system/" target="_blank" class="header-title">
                            <span >
                                桌上角色扮演遊戲（TRPG )<br>
                                系統全面導覽
                            </span>
						</a>
					</div>
					<div class="col-md-5 col-12 text-left p-3">
						<img src="image/dicecat_introduction.png" alt="骰子貓來介紹" class="img-fluid">
					</div>
				</div>
			</div>
		</div>
		<div class="tab-content active">
			<div class="col-lg-12 outer-container">
				<div class="col-lg-12 system-introduction">

					<div class="row d-flex align-items-center" style="padding-top: 2%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; ">
						<span   class="title-text" style="margin-bottom: 2%">
							什麼是TRPG系統？基本概念解析<br />
						</span>
						<span  id="Description">
							TRPG系統是設計用於桌上角色扮演遊戲的規則集，它提供了一個結構和框架，讓玩家可以扮演虛構的角色並參與一個共同的故事。TRPG系統通常包含角色創建規則、戰鬥系統、技能系統、魔法系統以及其他遊戲機制。</br>
							簡單來說，TRPG系統就是一個遊戲規則手冊，它讓玩家可以自由地創作故事，並在一個充滿想像力的世界中探索和冒險。TRPG系統通常使用骰子來解決遊戲中各種事件的結果，例如戰鬥、技能檢定、角色的行動等。
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- 系统介绍 -->
		<div id="system-overview" class="tab-content active">
			<div class="system-section">
				<div class="col-lg-12">
					<div class="row d-flex align-items-center" style="padding-top: 2%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; text-align: center;">
						<span  class="title-text">主要TRPG系統類型及特點介紹</span>
					</div>
				</div>
				<div id="category-container" style="margin: 1% 0; display: flex; justify-content: center; flex-wrap: wrap; "></div>

				<div id="SystemContent-container" class="accordding-container">
					<div class="col-lg-12 ">
						<div class="row d-flex align-items-center" style="padding-top: 4%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; text-align: left; ">
							<span class="fade-text" id="SystemStyle" style="margin-bottom : 2%">
								TRPG系統百百種，選對口味才玩得開心！<br />
							</span>
							<span class="fade-text" id="SystemStyle-Description" style="min-height:150px">
								你有想過當個抓鬼的神棍、打怪的劍士、還是陰影中潛伏的社畜間諜嗎？TRPG（桌上角色扮演遊戲）就像一場大型即興戲劇，每套系統都有自己的世界觀、玩法和風格。有的走驚悚路線，理智值掉滿地；有的充滿魔法與騎士，想飛天就飛天；也有那種日常搞笑型的，整場團打完大家只記得吐槽和亂入。<br />
								TRPG 的美妙之處就在於——風格超多，規則各異，你可以自由選擇最對你胃口的系統，打造屬於你的小宇宙。不管你是初入坑的新手，還是已經跑團到可以當 NPC 的老屁股，只要找到合拍的系統，就能馬上沉浸其中，哭、笑、尖叫、爆肝（？）都有人陪你一起體驗。<br />
								總之，別害羞，挑一種你喜歡的風格，來場說玩就玩的冒險旅程吧！
							</span>
						</div>
					</div>
				</div>
				<div id="systems-container" class="system-tags">
				</div>
			</div>

			<div class="content-container" id="system-content-container" style="display: none;">
				<div class="row d-flex  align-items-start" style="padding: 2% 5%;">
					<!-- 右側圖片 -->
					<div class="col-lg-6 image-section" id="system-image-section">
						<div class="swiper mySwiper" id="system-swiper">
							<div class="swiper-wrapper" id="system-swiper-wrapper">
							</div>
							<div class="swiper-button-next"></div>
							<div class="swiper-button-prev"></div>
							<div class="swiper-pagination"></div>
						</div>
					</div>

					<!-- 左側文字 -->
					<div class="col-lg-6 text-section">
						<span id="system-title" style="margin-bottom: 20px; font-weight: bold;"></span>
						<p class="quote" id="system-quote">这里是引言部分。</p><br />
						<p class="main-text" id="system-main-text">这里是内文的文字范例。</p>
						<p class="signature" id="system-signature">签名部分</p>
					</div>
				</div>
			</div>

			<!-- 动态生成的系统详细信息容器 -->
			<div id="dynamic-system-container"></div>


		</div>
		<!--文字雲-->
		<div class="Word-Cloud active">
			<div class="col-lg-12 outer-container">
				<div class="col-lg-12 ">

					<div class="row d-flex align-items-center justify-content-center text-center"
						 style="padding: 2% 5%;">
						<div class="col-lg-8">
							<span class="title-text" style=" margin-bottom: 1%;">
								快速探索系統風格
							</span>
							<span style="font-size: 1.1rem;">
								不知從哪開始？用不同角度看看各種 TRPG 系統的魅力！
							</span>
							<div id="explore-controls" class="explore-controls">
								<button id="btn-image-mode" class="explore-btn active">🖼️ 圖片模式</button>
								<button id="btn-text-mode" class="explore-btn">🔤 文字模式</button>
								<button id="btn-random-pick" class="explore-btn">🎲 隨機推薦</button>
							</div>
						</div>
					</div>
					<!-- Display Cloud Words -->
					<div id="word-cloud-container">
						<div id="word-cloud"></div>

					</div>
				</div>
			</div>
		</div>
		<!--事件區域-->
		<div class="event-section">
			<!--<div class="col-lg-12 outer-container">-->
				<div class="col-lg-12 system-introduction">
					<div class="row d-flex align-items-center justify-content-center text-center" style="padding: 2% 5%;">
						<div class="col-lg-8">
							<span class="section-title">近期 TRPG 活動推薦</span>
							<span class="section-description">
								還不知道要玩哪個系統嗎？也許可以從最近的推廣活動找靈感，看看主持人準備了哪些精彩冒險！
							</span>
						</div>
					</div>

					<div class="event-date-selector-wrapper" style="text-align: center; margin: 20px 0;">
						<select id="event-date-selector" class="event-date-selector">
							<option disabled selected>請選擇活動日期</option>
						</select>
					</div>
					<div class="events-container" id="events-container"></div>

				</div>
			<!--div-->
		</div>

	</div>
	<button id="backToTopBtn">回到最上面</button>
	<script>
	// --- 全局變量 ---
	let systemData = [];
	let eventsData = [];
	let SystemDescriptionData = {};

	// --- 核心：統一的頁面初始化入口 ---
	document.addEventListener("DOMContentLoaded", async () => {
		try {
			// 1. 首先，等待所有 JSON 資料載入完成
			await loadJsonFromFolder();

			// 2. 資料載入後，再初始化所有需要資料的 UI 元件
			generateCategoryButtonsFromData(); // 根據 systemData 產生分類按鈕
			generateCategorySelector(eventsData); // 根據 eventsData 產生日期下拉選單
			initializeWordCloud("image"); // 初始化文字雲

			// 3. 處理當前 URL 的參數，決定要顯示哪個系統/活動
			handleUrlParametersOnLoad();

			// 4. 綁定不需要等待資料載入的 UI 事件
			setupEventListeners();

		} catch (error) {
			console.error("頁面初始化失敗:", error);
			// 你可以在此處向用戶顯示錯誤訊息
		}
	});

	// --- 資料載入 ---
	async function loadJsonFromFolder(folderPath = 'data/') {
		try {
			// 加上 timestamp 防止 manifest.json 被快取
			const manifestRes = await fetch(`${folderPath}manifest.json?t=${Date.now()}`);
			const manifest = await manifestRes.json();
			const jsonFiles = manifest.files;

			const fetches = jsonFiles.map(filename =>
				fetch(`${folderPath}${filename}?t=${Date.now()}`)
				.then(res => {
					if (!res.ok) throw new Error(`讀取失敗：${filename} (${res.status})`);
					return res.json();
				})
			);

			const results = await Promise.all(fetches);
			
			// 將讀取到的資料存入全局變量
			systemData = results[0].details;
			eventsData = results[1].events;
			SystemDescriptionData = results[2].include;

		} catch (error) {
			console.error("讀取 JSON 資料時發生錯誤：", error);
			throw error; // 拋出錯誤，讓外層的 try...catch 可以捕獲
		}
	}
	
	// --- 頁面啟動邏輯 ---
	function handleUrlParametersOnLoad() {
		const params = new URLSearchParams(window.location.search);
		const date = params.get('date');
		let system = params.get('system');
		const master = params.get('master');

		if (date && master) {
			// 案例 1: URL 包含日期和主持人 ID (這是最高優先級)
			// 我們從 eventsData 中反查系統名稱
			if (!system) {
				const event = eventsData.find(e => e.date === date);
				if (event?.masters) {
					const masterInfo = event.masters.find(m => m.id === master);
					if (masterInfo) {
						system = masterInfo.system; // 成功找到系統名稱
					}
				}
			}
			renderEventCards(date); // 渲染該日期的所有活動卡片
			if (system) {
				displaySystemDetails(system, master, date, true); // 顯示詳細資訊
			} else {
				console.warn(`在 ${date} 的活動中找不到主持人 ${master} 的系統資訊。`);
			}

		} else if (system) {
			// 案例 2: URL 只包含系統名稱
			displaySystemDetails(system, null, null, true);
		}
	}

	// --- 事件綁定 ---
	function setupEventListeners() {
		// 回到頂部按鈕
		const btn = document.getElementById('backToTopBtn');
		window.addEventListener('scroll', () => {
			btn.style.display = window.scrollY > 200 ? 'block' : 'none';
		});
		btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

		// 瀏覽器上一頁/下一頁事件
		window.addEventListener('popstate', e => {
			if (e.state?.system) {
				// 修正了參數順序錯誤的問題
				displaySystemDetails(
					e.state.system,
					e.state.master || null,
					e.state.date || null,
					false
				);
			}
		});

		// 文字雲模式切換按鈕
		const modeButtons = {
			"btn-image-mode": "image",
			"btn-text-mode": "text",
			"btn-random-pick": "random"
		};
		Object.entries(modeButtons).forEach(([btnId, mode]) => {
			const btn = document.getElementById(btnId);
			if (btn) {
				btn.addEventListener("click", () => reloadCloud(mode));
			}
		});
		
		// 日期選擇器事件
		const dateSelector = document.getElementById('event-date-selector');
		dateSelector.addEventListener('change', function () {
			const selectedDate = this.value;
			renderEventCards(selectedDate);
			const eventBlock = document.getElementById('events-container');
			if (eventBlock) {
				eventBlock.scrollIntoView({ behavior: 'smooth' });
			}
		});
	}

	// --- UI 生成與更新 (以下是你的原始函式，稍作調整) ---

	function generateCategoryButtonsFromData() {
        const categories = [...new Set(
            systemData.flatMap(system =>
                system.category.split('、').map(tag => tag.trim())
            )
        )].sort((a, b) => a.length - b.length);
        categories.unshift("全部");
        generateCategoryButtons(categories); // 呼叫你原有的函式
    }

	function generateCategoryButtons(categories) {
		const categoryContainer = document.getElementById("category-container");
		categoryContainer.innerHTML = '';
		categories.forEach(category => {
			const button = document.createElement("button");
			button.textContent = category;
			button.className = "category-button";
			button.addEventListener("click", () => {
				ShowSystemStyleDescription(category);
			});
			categoryContainer.appendChild(button);
		});
	}

	function generateCategorySelector(events) {
		const selector = document.getElementById('event-date-selector');
		selector.innerHTML = '<option disabled selected>請選擇活動日期</option>';
		const uniqueDates = [...new Set(events.map(e => e.date))];
		uniqueDates.forEach(date => {
			const option = document.createElement('option');
			option.value = date;
			option.textContent = date;
			selector.appendChild(option);
		});
	}
	
	function initializeWordCloud(mode) {
		const wordCloudElement = document.getElementById("word-cloud");
		const parent = wordCloudElement.parentElement;
		const parentWidth = parent.clientWidth;
		const cloudSize = Math.min(parentWidth * 0.8, 600);
		const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

		// 直接使用已載入的 systemData，不再重複 fetch
		if (mode === "random") {
			const randomSystem = systemData[Math.floor(Math.random() * systemData.length)];
			displaySystemDetails(randomSystem.system, null, null, true);
			return;
		}

		const entries = systemData.map(system => {
			if (mode === "text") {
				return { label: `${system.system}《${system.system_EN}》`, systemName: system.system };
			} else if (mode === "image") {
				return {
					image: './image/' + system.image1,
					width: isMobile ? 80 : 140,
					height: isMobile ? 80 : 140,
					systemName: system.system
				};
			}
		});

		const settings = {
			entries,
			width: parentWidth,
			height: isMobile ? cloudSize + 100 : cloudSize,
			radius: '100%',
			radiusMin: 75,
			bgDraw: false,
			opacityOver: 1.0,
			opacityOut: 0.05,
			opacitySpeed: 6,
			fov: 800,
			speed: isMobile ? 0.2 : 0.3,
			fontFamily: "Arial, sans-serif",
			fontSize: isMobile ? 13 : 18,
			fontColor: "#fff",
			fontWeight: "bold",
			onClick(systemName) {
				const parsed = systemName.split("《")[0].trim();
				displaySystemDetails(parsed, null, null, true);
			}
		};
		
		new SVG3DTagCloud(wordCloudElement, settings);
	}

	// 共用刷新文字雲方法
	let currentCloudMode = "image";
	function reloadCloud(mode) {
		currentCloudMode = mode;
		const wordCloudElement = document.getElementById("word-cloud");
		wordCloudElement.innerHTML = "";
		initializeWordCloud(mode);
	}
	// 監聽視窗大小變化以重繪文字雲
	window.addEventListener("resize", () => reloadCloud(currentCloudMode));


	// --- 其他所有你的函式維持不變 ---
	// (例如: displaySystemDetails, renderEventCards, ShowSystemStyleDescription, etc.)
	// ... 將你其他的函式貼在這裡 ...
	// function renderEventCards(TargetData) { ... }
	// function ShowSystemStyleDescription(SystemStyle) { ... }
	// ... etc ...
	// 你的所有函式，例如 displaySystemDetails, clean, generateSystemTabs 等等，都可以原封不動地複製到這裡。
	// 以下貼上你原有的函式，確保它們都能被呼叫到

	function renderEventCards(TargetData) {
		const container = document.getElementById('events-container');
		container.innerHTML = ''; // 清空
		const event = eventsData.find(e => e.date === TargetData);
		if (!event || !event.masters) {
			container.innerHTML = '<p>此日期下沒有活動。</p>';
			return;
		}
		event.masters.forEach(master => {
			const card = document.createElement('a');
			card.className = 'event-card';
			card.innerHTML = `
				<span>主持人：${master.name}</span> <br>
				<span>系統：${master.system}（${master.system_EN}）</span>
			`;
			card.addEventListener('click', () => {
				displaySystemDetails(master.system, master.id, event.date, true);
				document.querySelectorAll('.event-card').forEach(c => c.classList.remove('active'));
				card.classList.add('active');
			});
			container.appendChild(card);
		});
	}

	function ShowSystemStyleDescription(SystemStyle) {
		const match = SystemDescriptionData.find(data => data.name === SystemStyle);
		if (match) {
			const titleEl = document.getElementById("SystemStyle");
			const descEl = document.getElementById("SystemStyle-Description");
			let displayName = match.name;
			if (displayName === "全部") { displayName = "小孩子才做選擇！我全都要！"; }
			fadeTextChange(titleEl, displayName);
			fadeTextChange(descEl, match.description);
		}
		displaySystemsByCategory(SystemStyle);
		const sysContainer = document.getElementById("systems-container");
		if (sysContainer && !sysContainer.classList.contains("active")) {
			sysContainer.style.display = "block";
			setTimeout(() => {
				sysContainer.classList.add("active");
			}, 400);
		}
		const SysContenter = document.getElementById("system-content-container");
		if (SysContenter) {
			SysContenter.classList.add("hide");
			setTimeout(() => {
				SysContenter.style.display = "none";
			}, 500);
		}
	}

	function displaySystemsByCategory(category) {
		const filtered = (category === "全部")
			? systemData
			: systemData.filter(system => system.category.includes(category));
		generateSystemTabs(filtered);
	}

	function generateSystemTabs(systems) {
		const systemsContainer = document.getElementById('systems-container');
		systemsContainer.innerHTML = '';
		const table = document.createElement('table');
		table.className = 'system-table';
		const showAllRow = document.createElement('tr');
		const showAllCell = document.createElement('td');
		showAllCell.className = 'system-title-cell';
		showAllCell.colSpan = 2;
		showAllCell.textContent = '系統一覽';
		showAllRow.appendChild(showAllCell);
		table.appendChild(showAllRow);
		let row;
		systems.forEach((system, index) => {
			if (index % 2 === 0) {
				row = document.createElement('tr');
				table.appendChild(row);
			}
			const cell = document.createElement('td');
			cell.className = 'system-cell ' + (Math.floor(index / 2) % 2 === 0 ? 'system-row-even' : 'system-row-odd');
			cell.setAttribute('data-system', system.system);
			const textSpan = document.createElement('span');
			textSpan.className = 'system-fade';
			textSpan.textContent = `${system.system}《${system.system_EN}》`;
			cell.appendChild(textSpan);
			setTimeout(() => textSpan.style.opacity = '1', 20 * index);
			cell.addEventListener('click', () => {
				document.querySelectorAll('#systems-container td').forEach(td => {
					td.classList.remove('active');
					td.classList.remove('system-row-even', 'system-row-odd');
					const r = Math.floor([...td.parentNode.parentNode.children].indexOf(td.parentNode) - 1);
					if (r >= 0) {
						td.classList.add(r % 2 === 0 ? 'system-row-even' : 'system-row-odd');
					}
				});
				cell.classList.add('active');
				const container = document.getElementById('system-content-container');
				container.style.display = 'block';
				container.classList.remove('hide');
				displaySystemDetails(system.system, null, system.update, true);
			});
			row.appendChild(cell);
		});
		systemsContainer.appendChild(table);
	}

	function clean(str) {
		return str
			?.toString()
			.replace(/[\u200B-\u200D\uFEFF]/g, '')
			.replace(/\s/g, '')
			.trim();
	}

	function displaySystemDetails(systemName, masterId, eventDate, shouldUpdateUrl = false) {
		const systemContentContainer = document.getElementById('system-content-container');
		let displayData = null;
		let masterInfo = null;
		let system_EN = null;
		if (eventDate && masterId) {
			const event = eventsData.find(e => e.date === eventDate);
			if (event && event.masters) {
				masterInfo = event.masters.find(m => m.id === masterId);
				if (masterInfo) {
					system_EN = masterInfo.system_EN;
				}
			}
		}
		if (systemName && !system_EN) {
			const system = systemData.find(s => clean(s.system).includes(clean(systemName)));
			if (system) {
				system_EN = system.system_EN;
			}
		}
		if (system_EN) {
			const system = systemData.find(s => clean(s.system_EN) === clean(system_EN));
			if (system) {
				displayData = {
					system: system.system,
					system_EN: system.system_EN,
					quote: system.Quote,
					description: system.Description,
					author: system.Author,
					image1: system.image1,
					image2: system.image2
				};
			}
		}
		if (masterInfo) {
			if (!displayData) { displayData = {}; }
			displayData.system = masterInfo.system || displayData.system;
			displayData.system_EN = masterInfo.system_EN || displayData.system_EN;
			displayData.quote = masterInfo.quote || displayData.quote;
			displayData.description = masterInfo.description || displayData.description;
			displayData.author = masterInfo.name;
			displayData.image1 = masterInfo.image1 || displayData.image1;
			displayData.image2 = masterInfo.image2 || displayData.image2;
		}
		if (!displayData) {
			console.error("找不到系統資料:", { systemName, system_EN, masterId, eventDate });
			systemContentContainer.style.display = 'none';
			return;
		}
		document.getElementById('system-title').innerHTML = ` ${displayData.system} <br>《${displayData.system_EN}》`;
		document.getElementById('system-quote').textContent = displayData.quote ? `“${displayData.quote}”` : "";
		document.getElementById('system-main-text').innerHTML = displayData.description || "";
		document.getElementById('system-signature').innerHTML = `本介紹文由 ${displayData.author} 撰寫。<br>本文用於桃園TRPG推廣會活動使用。`;
		const swiperWrapper = document.getElementById('system-swiper-wrapper');
		swiperWrapper.innerHTML = '';
		[displayData.image1, displayData.image2].forEach((imagePath, index) => {
			if (imagePath) {
				const slide = document.createElement('div');
				slide.className = 'swiper-slide';
				const img = document.createElement('img');
				img.src = `image/${imagePath}`;
				img.alt = `image${index + 1}`;
				slide.appendChild(img);
				swiperWrapper.appendChild(slide);
			}
		});
		if (window.systemSwiper) {
			window.systemSwiper.destroy(true, true);
		}
		window.systemSwiper = new Swiper(".mySwiper", {
			loop: true,
			navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
			pagination: { el: ".swiper-pagination", clickable: true },
			autoplay: { delay: 5000, disableOnInteraction: false }
		});
		systemContentContainer.style.display = 'block';
		systemContentContainer.scrollIntoView({ behavior: 'smooth' });
		if (shouldUpdateUrl) {
			const stateData = {
				system: displayData.system,
				date: eventDate || null,
				master: masterId || null
			};
			const params = new URLSearchParams();
			params.set('system', stateData.system);
			if (stateData.date) params.set('date', stateData.date);
			if (stateData.master) params.set('master', stateData.master);
			const newUrl = `${window.location.pathname}?${params.toString()}`;
			if (newUrl !== window.location.href) {
				history.pushState(stateData, '', newUrl);
			}
		}
	}
	
	function fadeTextChange(element, newText) {
		if (!element) return;
		element.classList.add('fade-out');
		setTimeout(() => {
			element.innerHTML = newText;
			element.classList.remove('fade-out');
		}, 300);
	}
</script>

</body>
</html>
