<script>
  // æª¢æŸ¥è¦–çª—å¯¬åº¦æ˜¯å¦å°æ–¼ 600ï¼Œå¦‚æœæ˜¯å°±å°å‘ index_mobile.html
  //console.log(screen.width);
  //if (screen.width < 600 && !location.pathname.includes("index_mobile.html")) {
  //  location.href = "index_mobile.html" + location.search;
  //}
</script>
<!DOCTYPE html>
<html lang="en">
<head>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
	<script src="js/svg3DTagCloud.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Swiper CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
	<!-- Swiper JS -->
	<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="css/SystemStyle.css">
	<title>æ¡ƒåœ’TRPGæ¨å»£æœƒç³»çµ±ä»‹ç´¹</title>
</head>
<body>
	<div class="container">
		<!--æ¨™é¡Œå€åŸŸ-->
		<div class="header-container ">
			<div class="col-lg-12">
				<div class="row d-flex align-items-center">
					<div class="col-md-7 col-12 text-left p-3">
						<a href="https://sleepyknife.github.io/tyntrpg_system/" target="_blank" class="header-title">
                            <span >
                                æ¡Œä¸Šè§’è‰²æ‰®æ¼”éŠæˆ²ï¼ˆTRPG )<br>
                                ç³»çµ±å…¨é¢å°è¦½
                            </span>
						</a>
					</div>
					<div class="col-md-5 col-12 text-left p-3">
						<img src="image/dicecat_introduction.png" alt="éª°å­è²“ä¾†ä»‹ç´¹" class="img-fluid">
					</div>
				</div>
			</div>
		</div>
		<div class="tab-content active">
			<div class="col-lg-12 outer-container">
				<div class="col-lg-12 system-introduction">

					<div class="row d-flex align-items-center" style="padding-top: 2%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; ">
						<span   class="title-text" style="margin-bottom: 2%">
							ä»€éº¼æ˜¯TRPGç³»çµ±ï¼ŸåŸºæœ¬æ¦‚å¿µè§£æ<br />
						</span>
						<span  id="Description">
							TRPGç³»çµ±æ˜¯è¨­è¨ˆç”¨æ–¼æ¡Œä¸Šè§’è‰²æ‰®æ¼”éŠæˆ²çš„è¦å‰‡é›†ï¼Œå®ƒæä¾›äº†ä¸€å€‹çµæ§‹å’Œæ¡†æ¶ï¼Œè®“ç©å®¶å¯ä»¥æ‰®æ¼”è™›æ§‹çš„è§’è‰²ä¸¦åƒèˆ‡ä¸€å€‹å…±åŒçš„æ•…äº‹ã€‚TRPGç³»çµ±é€šå¸¸åŒ…å«è§’è‰²å‰µå»ºè¦å‰‡ã€æˆ°é¬¥ç³»çµ±ã€æŠ€èƒ½ç³»çµ±ã€é­”æ³•ç³»çµ±ä»¥åŠå…¶ä»–éŠæˆ²æ©Ÿåˆ¶ã€‚</br>
							ç°¡å–®ä¾†èªªï¼ŒTRPGç³»çµ±å°±æ˜¯ä¸€å€‹éŠæˆ²è¦å‰‡æ‰‹å†Šï¼Œå®ƒè®“ç©å®¶å¯ä»¥è‡ªç”±åœ°å‰µä½œæ•…äº‹ï¼Œä¸¦åœ¨ä¸€å€‹å……æ»¿æƒ³åƒåŠ›çš„ä¸–ç•Œä¸­æ¢ç´¢å’Œå†’éšªã€‚TRPGç³»çµ±é€šå¸¸ä½¿ç”¨éª°å­ä¾†è§£æ±ºéŠæˆ²ä¸­å„ç¨®äº‹ä»¶çš„çµæœï¼Œä¾‹å¦‚æˆ°é¬¥ã€æŠ€èƒ½æª¢å®šã€è§’è‰²çš„è¡Œå‹•ç­‰ã€‚
						</span>
					</div>
				</div>
			</div>
		</div>

		<!-- ç³»ç»Ÿä»‹ç» -->
		<div id="system-overview" class="tab-content active">
			<div class="system-section">
				<div class="col-lg-12">
					<div class="row d-flex align-items-center" style="padding-top: 2%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; text-align: center;">
						<span  class="title-text">ä¸»è¦TRPGç³»çµ±é¡å‹åŠç‰¹é»ä»‹ç´¹</span>
					</div>
				</div>
				<div id="category-container" style="margin: 1% 0; display: flex; justify-content: center; flex-wrap: wrap; "></div>

				<div id="SystemContent-container" class="accordding-container">
					<div class="col-lg-12 ">
						<div class="row d-flex align-items-center" style="padding-top: 4%; padding-bottom: 2%; padding-right: 5%; padding-left: 5%; text-align: left; ">
							<span class="fade-text" id="SystemStyle" style="margin-bottom : 2%">
								TRPGç³»çµ±ç™¾ç™¾ç¨®ï¼Œé¸å°å£å‘³æ‰ç©å¾—é–‹å¿ƒï¼<br />
							</span>
							<span class="fade-text" id="SystemStyle-Description" style="min-height:150px">
								ä½ æœ‰æƒ³éç•¶å€‹æŠ“é¬¼çš„ç¥æ£ã€æ‰“æ€ªçš„åŠå£«ã€é‚„æ˜¯é™°å½±ä¸­æ½›ä¼çš„ç¤¾ç•œé–“è«œå—ï¼ŸTRPGï¼ˆæ¡Œä¸Šè§’è‰²æ‰®æ¼”éŠæˆ²ï¼‰å°±åƒä¸€å ´å¤§å‹å³èˆˆæˆ²åŠ‡ï¼Œæ¯å¥—ç³»çµ±éƒ½æœ‰è‡ªå·±çš„ä¸–ç•Œè§€ã€ç©æ³•å’Œé¢¨æ ¼ã€‚æœ‰çš„èµ°é©šæ‚šè·¯ç·šï¼Œç†æ™ºå€¼æ‰æ»¿åœ°ï¼›æœ‰çš„å……æ»¿é­”æ³•èˆ‡é¨å£«ï¼Œæƒ³é£›å¤©å°±é£›å¤©ï¼›ä¹Ÿæœ‰é‚£ç¨®æ—¥å¸¸æç¬‘å‹çš„ï¼Œæ•´å ´åœ˜æ‰“å®Œå¤§å®¶åªè¨˜å¾—åæ§½å’Œäº‚å…¥ã€‚<br />
								TRPG çš„ç¾å¦™ä¹‹è™•å°±åœ¨æ–¼â€”â€”é¢¨æ ¼è¶…å¤šï¼Œè¦å‰‡å„ç•°ï¼Œä½ å¯ä»¥è‡ªç”±é¸æ“‡æœ€å°ä½ èƒƒå£çš„ç³»çµ±ï¼Œæ‰“é€ å±¬æ–¼ä½ çš„å°å®‡å®™ã€‚ä¸ç®¡ä½ æ˜¯åˆå…¥å‘çš„æ–°æ‰‹ï¼Œé‚„æ˜¯å·²ç¶“è·‘åœ˜åˆ°å¯ä»¥ç•¶ NPC çš„è€å±è‚¡ï¼Œåªè¦æ‰¾åˆ°åˆæ‹çš„ç³»çµ±ï¼Œå°±èƒ½é¦¬ä¸Šæ²‰æµ¸å…¶ä¸­ï¼Œå“­ã€ç¬‘ã€å°–å«ã€çˆ†è‚ï¼ˆï¼Ÿï¼‰éƒ½æœ‰äººé™ªä½ ä¸€èµ·é«”é©—ã€‚<br />
								ç¸½ä¹‹ï¼Œåˆ¥å®³ç¾ï¼ŒæŒ‘ä¸€ç¨®ä½ å–œæ­¡çš„é¢¨æ ¼ï¼Œä¾†å ´èªªç©å°±ç©çš„å†’éšªæ—…ç¨‹å§ï¼
							</span>
						</div>
					</div>
				</div>
				<div id="systems-container" class="system-tags">
				</div>
			</div>

			<div class="content-container" id="system-content-container" style="display: none;">
				<div class="row d-flex  align-items-start" style="padding: 2% 5%;">
					<!-- å³å´åœ–ç‰‡ -->
					<div class="col-lg-6 image-section" id="system-image-section">
						<div class="swiper mySwiper" id="system-swiper">
							<div class="swiper-wrapper" id="system-swiper-wrapper">
							</div>
							<div class="swiper-button-next"></div>
							<div class="swiper-button-prev"></div>
							<div class="swiper-pagination"></div>
						</div>
					</div>

					<!-- å·¦å´æ–‡å­— -->
					<div class="col-lg-6 text-section">
						<span id="system-title" style="margin-bottom: 20px; font-weight: bold;"></span>
						<p class="quote" id="system-quote">è¿™é‡Œæ˜¯å¼•è¨€éƒ¨åˆ†ã€‚</p><br />
						<p class="main-text" id="system-main-text">è¿™é‡Œæ˜¯å†…æ–‡çš„æ–‡å­—èŒƒä¾‹ã€‚</p>
						<p class="signature" id="system-signature">ç­¾åéƒ¨åˆ†</p>
					</div>
				</div>
			</div>

			<!-- åŠ¨æ€ç”Ÿæˆçš„ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯å®¹å™¨ -->
			<div id="dynamic-system-container"></div>


		</div>
		<!--æ–‡å­—é›²-->
		<div class="Word-Cloud active">
			<div class="col-lg-12 outer-container">
				<div class="col-lg-12 ">

					<div class="row d-flex align-items-center justify-content-center text-center"
						 style="padding: 2% 5%;">
						<div class="col-lg-8">
							<span class="title-text" style=" margin-bottom: 1%;">
								å¿«é€Ÿæ¢ç´¢ç³»çµ±é¢¨æ ¼
							</span>
							<span style="font-size: 1.1rem;">
								ä¸çŸ¥å¾å“ªé–‹å§‹ï¼Ÿç”¨ä¸åŒè§’åº¦çœ‹çœ‹å„ç¨® TRPG ç³»çµ±çš„é­…åŠ›ï¼
							</span>
							<div id="explore-controls" class="explore-controls">
								<button id="btn-image-mode" class="explore-btn active">ğŸ–¼ï¸ åœ–ç‰‡æ¨¡å¼</button>
								<button id="btn-text-mode" class="explore-btn">ğŸ”¤ æ–‡å­—æ¨¡å¼</button>
								<button id="btn-random-pick" class="explore-btn">ğŸ² éš¨æ©Ÿæ¨è–¦</button>
							</div>
						</div>
					</div>
					<!-- Display Cloud Words -->
					<div id="word-cloud-container">
						<div id="word-cloud"></div>

					</div>
				</div>
			</div>
		</div>
		<!--äº‹ä»¶å€åŸŸ-->
		<div class="event-section">
			<!--<div class="col-lg-12 outer-container">-->
				<div class="col-lg-12 system-introduction">
					<div class="row d-flex align-items-center justify-content-center text-center" style="padding: 2% 5%;">
						<div class="col-lg-8">
							<span class="section-title">è¿‘æœŸ TRPG æ´»å‹•æ¨è–¦</span>
							<span class="section-description">
								é‚„ä¸çŸ¥é“è¦ç©å“ªå€‹ç³»çµ±å—ï¼Ÿä¹Ÿè¨±å¯ä»¥å¾æœ€è¿‘çš„æ¨å»£æ´»å‹•æ‰¾éˆæ„Ÿï¼Œçœ‹çœ‹ä¸»æŒäººæº–å‚™äº†å“ªäº›ç²¾å½©å†’éšªï¼
							</span>
						</div>
					</div>

					<div class="event-date-selector-wrapper" style="text-align: center; margin: 20px 0;">
						<select id="event-date-selector" class="event-date-selector">
							<option disabled selected>è«‹é¸æ“‡æ´»å‹•æ—¥æœŸ</option>
						</select>
					</div>
					<div class="events-container" id="events-container"></div>

				</div>
			<!--div-->
		</div>

	</div>
	<button id="backToTopBtn">å›åˆ°æœ€ä¸Šé¢</button>
	<script>
		
		// å…¨å±€è®Šé‡ä¾†å­˜å„²è®€å–çš„äº‹ä»¶è³‡æ–™
		let systemData = [];
		let eventsData = [];
		let uniqueCategories = new Set();
        let SystemDescriptionData = {};
		const paramsOnLoad = new URLSearchParams(window.location.search);

        window.addEventListener("DOMContentLoaded", () => {
            loadJsonFromFolder().then(() => {
                const params = new URLSearchParams(window.location.search);
                const date = params.get('date');
                const system = params.get('system');
                const master = params.get('master');

                if (date && master) {
                    renderEventCards(date);
                    displaySystemDetails(system, master, date, true);
                }
                else if (system) {
                    displaySystemDetails(system, null,  null, true);
                    document.getElementById('system-content-container')?.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

		//è‡ªå‹•åŒ–ç²¾ç°¡è®€å–jsonï¼Œå¦‚æœéœ€è¦è¿½åŠ ä¿®æ”¹jsonæ•¸é‡ï¼Œä¸€å¾‹å»manifest.jsonæ”¹ï¼Œè®“htmlæ¸›è‚¥
        async function loadJsonFromFolder(folderPath = 'data/') {
            try {
                const manifestRes = await fetch(`${folderPath}manifest.json`);
                const manifest = await manifestRes.json();

                const jsonFiles = manifest.files;

                const fetches = jsonFiles.map(filename =>
                    fetch(`${folderPath}${filename}?t=${Date.now()}`)
                        .then(res => {
                            if (!res.ok) throw new Error(`è®€å–å¤±æ•—ï¼š${filename} (${res.status})`);
                            return res.json();
                        })
                );

				const results = await Promise.all(fetches);
                // å°çµæœä¾ç…§é †åºè™•ç†ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
                systemData = results[0].details;
                eventsData = results[1].events; // from events.json
                SystemDescriptionData = results[2].include;

                // è™•ç†è³‡æ–™
                generateSystemTabs(systemData);
                const Categories = [...new Set(
                    systemData.flatMap(system =>
                        system.category.split('ã€').map(tag => tag.trim())
                    )
				)].sort((a, b) => a.length - b.length);
                Categories.unshift("å…¨éƒ¨");
                generateCategoryButtons(Categories);
                generateCategorySelector(eventsData);

            } catch (error) {
                console.error("è®€å– JSON è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
            }
        }


		// å‹•æ…‹ç”Ÿæˆæ—¥æœŸä¸‹æ‹‰é¸å–®
        function generateCategorySelector(events) {
            const selector = document.getElementById('event-date-selector');
            selector.innerHTML = '<option disabled selected>è«‹é¸æ“‡æ´»å‹•æ—¥æœŸ</option>'; 
            // å»ºç«‹å”¯ä¸€æ—¥æœŸé›†åˆ
            const uniqueDates = [...new Set(events.map(e => e.date))];

            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                selector.appendChild(option);
            });

            selector.addEventListener('change', function () {
                const eventBlock = document.getElementById('events-container');
                if (eventBlock) {
                    eventBlock.scrollIntoView({ behavior: 'smooth' });
                }
			});

            document.getElementById('event-date-selector').addEventListener('change', function () {
                const selectedDate = this.value;
                renderEventCards(selectedDate);
            });
        }	
		
		// æ ¹æ“šæ‰€é¸æ—¥æœŸé¡¯ç¤ºå°æ‡‰çš„æ´»å‹•
        function renderEventCards(TargetData) {
            const container = document.getElementById('events-container');
            container.innerHTML = ''; // æ¸…ç©º

            const event = eventsData.find(e => e.date === TargetData);
            if (!event || !event.masters) {
                container.innerHTML = '<p>æ­¤æ—¥æœŸä¸‹æ²’æœ‰æ´»å‹•ã€‚</p>';
                return;
            }

            event.masters.forEach(master => {
                const card = document.createElement('a');
                card.className = 'event-card';
                card.innerHTML = `
                    <span>ä¸»æŒäººï¼š${master.name}</span> <br>
                    <span>ç³»çµ±ï¼š${master.system}ï¼ˆ${master.system_EN}ï¼‰</span>
                `;
                card.addEventListener('click', () => {
                    displaySystemDetails(master.system, master.id, event.date, true);
                    document.querySelectorAll('.event-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                });
                container.appendChild(card);
            });
        }
		
        // è™•ç†ç€è¦½å™¨è¿”å›æ™‚é¡¯ç¤ºæ´»å‹•è©³æƒ…
        window.addEventListener('popstate', e => {
            if (e.state?.system) {
                displaySystemDetails(
                    e.state.master || null,
                    e.state.system,
                    e.state.date || null,
                    false 
                );
            }
        });
        // å›åˆ°é ‚éƒ¨æŒ‰éˆ•åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            // å›åˆ°é ‚éƒ¨æŒ‰éˆ•åŠŸèƒ½
            const btn = document.getElementById('backToTopBtn');
            window.addEventListener('scroll', () => {
                btn.style.display = window.scrollY > 200 ? 'block' : 'none';
            });
            btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            
            const params = new URLSearchParams(window.location.search);
            const systemParam = params.get('system');

            if (systemParam) {
                displaySystemDetails(
                    history.state?.master || null,
                    systemParam,
                    history.state?.date || null,
                    false
                );
            }
        });

        // é¡¯ç¤ºç³»çµ±é¢¨æ ¼çš„ä»‹ç´¹
        function ShowSystemStyleDescription(SystemStyle) {

            const match = SystemDescriptionData.find(data => data.name === SystemStyle);
            if (match) {
                const titleEl = document.getElementById("SystemStyle");
                const descEl = document.getElementById("SystemStyle-Description");
                if (match.name == "å…¨éƒ¨") { match.name = "å°å­©å­æ‰åšé¸æ“‡ï¼æˆ‘å…¨éƒ½è¦ï¼" };
                fadeTextChange(titleEl, match.name);
                fadeTextChange(descEl, match.description);
            }

            displaySystemsByCategory(SystemStyle);

            //å½ˆå‡ºç³»çµ±åˆ—è¡¨
            const sysContainer = document.getElementById("systems-container");
            if (sysContainer && !sysContainer.classList.contains("active")) {
                sysContainer.style.display = "block";
                setTimeout(() => {
                    sysContainer.classList.add("active");
                }, 400);
            }

            //æ”¶èµ·ç³»çµ±è©³ç´°ä»‹ç´¹
            const SysContenter = document.getElementById("system-content-container");
            if (SysContenter) {
                SysContenter.classList.add("hide");
                setTimeout(() => {
                    SysContenter.style.display = "none";
                }, 500);

            }
        }

        // é¡¯ç¤ºæ‰€é¸åˆ†é¡çš„ç³»çµ±
        function displaySystemsByCategory(category) {
            const filtered = (category === "å…¨éƒ¨")
                ? systemData
                : systemData.filter(system => system.category.includes(category));

            generateSystemTabs(filtered); // æ ¹æ“šéæ¿¾å¾Œçš„ç³»çµ±é¡¯ç¤ºç´°ç¯€
        }

		// åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæ ‡ç­¾ï¼ŒTable
        function generateSystemTabs(systems) {
            const systemsContainer = document.getElementById('systems-container');
            systemsContainer.innerHTML = '';

            const table = document.createElement('table');
            table.className = 'system-table';

            // æ¨™é¡Œåˆ—
            const showAllRow = document.createElement('tr');
            const showAllCell = document.createElement('td');
            showAllCell.className = 'system-title-cell';
            showAllCell.colSpan = 2;
            showAllCell.textContent = 'ç³»çµ±ä¸€è¦½';
            showAllRow.appendChild(showAllCell);
            table.appendChild(showAllRow);

            let row;
            systems.forEach((system, index) => {
                if (index % 2 === 0) {
                    row = document.createElement('tr');
                    table.appendChild(row);
                }

                const cell = document.createElement('td');
                cell.className = 'system-cell ' + (Math.floor(index / 2) % 2 === 0 ? 'system-row-even' : 'system-row-odd');
                cell.setAttribute('data-system', system.system);

                const textSpan = document.createElement('span');
                textSpan.className = 'system-fade';
                textSpan.textContent = `${system.system}ã€Š${system.system_EN}ã€‹`;
                cell.appendChild(textSpan);

                // æ¼¸å±¤é¡¯ç¤º
                setTimeout(() => textSpan.style.opacity = '1', 20 * index);

                // é»æ“Šäº‹ä»¶
                cell.addEventListener('click', () => {
                    document.querySelectorAll('#systems-container td').forEach(td => {
                        td.classList.remove('active');
                        td.classList.remove('system-row-even', 'system-row-odd');
                        const r = Math.floor([...td.parentNode.parentNode.children].indexOf(td.parentNode) - 1);
                        if (r >= 0) {
                            td.classList.add(r % 2 === 0 ? 'system-row-even' : 'system-row-odd');
                        }
                    });

                    cell.classList.add('active');
                    const container = document.getElementById('system-content-container');
                    container.style.display = 'block';
                    container.classList.remove('hide');
                    displaySystemDetails(system.system, null,  system.update, true);
                });

                row.appendChild(cell);
            });

            systemsContainer.appendChild(table);
        }
		
		function clean(str) {
		  return str
			?.toString()
			.replace(/[\u200B-\u200D\uFEFF]/g, '') // æ¸…æ‰é›¶å¯¬ç©ºç™½ã€FEFFã€å…¶ä»–å¥‡æ€ªå­—å…ƒ
			.replace(/\s/g, '') // æ¸…æ‰å¯è¦‹ç©ºç™½ï¼ˆåŠå½¢ã€å…¨å½¢ã€tabï¼‰
			.trim();
		}

		// æ ¹æ®ç³»ç»Ÿæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        function displaySystemDetails(systemName, masterId, eventDate, shouldUpdateUrl = false) {
            const systemContentContainer = document.getElementById('system-content-container');
            let displayData = null;
            let masterInfo = null;

            // If we have event details, find the master info.
            if (eventDate && masterId) {
                const event = eventsData.find(e => e.date === eventDate);
                if (event && event.masters) {
                    masterInfo = event.masters.find(m => m.id === masterId);
                }
            }

            // If systemName is missing, try to get it from the master info.
            if (!systemName && masterInfo) {
                systemName = masterInfo.system;
            }

            // Now, find the system details from the main system list.
            if (systemName) {
                const system = systemData.find(s => clean(s.system).includes(clean(systemName)));
                if (system) {
                    // Use system data as a base
                    displayData = {
                        system: system.system,
                        system_EN: system.system_EN,
                        quote: system.Quote,
                        description: system.Description,
                        author: system.Author,
                        image1: system.image1,
                        image2: system.image2
                    };
                }
            }

            // If we have master-specific info, use it to override.
            if (masterInfo) {
                // If there was no base system data, create an object
                if (!displayData) {
                    displayData = {};
                }
                displayData.system = masterInfo.system || displayData.system;
                displayData.system_EN = masterInfo.system_EN || displayData.system_EN;
                displayData.quote = masterInfo.quote || displayData.quote;
                displayData.description = masterInfo.description || displayData.description;
                displayData.author = masterInfo.name; // Master's name always overrides author
                displayData.image1 = masterInfo.image1 || displayData.image1;
                displayData.image2 = masterInfo.image2 || displayData.image2;
            }


            if (!displayData) {
                console.error("æ‰¾ä¸åˆ°ç³»çµ±è³‡æ–™:", { systemName, masterId, eventDate });
                systemContentContainer.style.display = 'none';
                return;
            }

            // Update DOM with displayData
            document.getElementById('system-title').innerHTML = ` ${displayData.system} <br>ã€Š${displayData.system_EN}ã€‹`;
            document.getElementById('system-quote').textContent = displayData.quote ? `â€œ${displayData.quote}â€` : "";
            document.getElementById('system-main-text').innerHTML = displayData.description || "";
            document.getElementById('system-signature').innerHTML = `æœ¬ä»‹ç´¹æ–‡ç”± ${displayData.author} æ’°å¯«ã€‚<br>æœ¬æ–‡ç”¨æ–¼æ¡ƒåœ’TRPGæ¨å»£æœƒæ´»å‹•ä½¿ç”¨ã€‚`;

            // Update images in swiper
            const swiperWrapper = document.getElementById('system-swiper-wrapper');
            swiperWrapper.innerHTML = ''; // Clear existing slides

            [displayData.image1, displayData.image2].forEach((imagePath, index) => {
                if (imagePath) {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    const img = document.createElement('img');
                    img.src = `image/${imagePath}`;
                    img.alt = `image${index + 1}`;
                    slide.appendChild(img);
                    swiperWrapper.appendChild(slide);
                }
            });

            // Re-initialize Swiper
            if (window.systemSwiper) {
                window.systemSwiper.destroy(true, true);
            }
            window.systemSwiper = new Swiper(".mySwiper", {
                loop: true,
                navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
                pagination: { el: ".swiper-pagination", clickable: true },
                autoplay: { delay: 5000, disableOnInteraction: false }
            });

            // Show container and scroll
            systemContentContainer.style.display = 'block';
            systemContentContainer.scrollIntoView({ behavior: 'smooth' });

            // Update URL
            if (shouldUpdateUrl) {
                const stateData = {
                    system: displayData.system,
                    date: eventDate || null,
                    master: masterId || null
                };

                const params = new URLSearchParams();
                params.set('system', stateData.system);
                if (stateData.date) params.set('date', stateData.date);
                if (stateData.master) params.set('master', stateData.master);

                const newUrl = `${window.location.pathname}?${params.toString()}`;
                if (newUrl !== window.location.href) {
                     history.pushState(stateData, '', newUrl);
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            let currentMode = "image";
            const wordCloudElement = document.getElementById("word-cloud");

            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿ
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // åˆå§‹åŒ–æ–‡å­—é›²
        function initializeWordCloud(mode) {
                const parent = wordCloudElement.parentElement;
                const parentWidth = parent.clientWidth;
                const cloudSize = Math.min(parentWidth * 0.8, 600);

                fetch('data/system.json')
                    .then(res => res.json())
                    .then(data => {
                        const systemData = data.details;

                        if (mode === "random") {
                            const randomSystem = systemData[Math.floor(Math.random() * systemData.length)];
                            window.displaySystemDetails(null, randomSystem.system, randomSystem.update, true);
                            return;
                        }

                        const entries = systemData.map(system => {
                            if (mode === "text") {
                                return { label: `${system.system}ã€Š${system.system_EN}ã€‹`, systemName: system.system };
                            } else if (mode === "image") {
                                return {
                                    image: './image/' + system.image1,
                                    width: isMobile ? 80 : 140,
                                    height: isMobile ? 80 : 140,
                                    systemName: system.system
                                };
                            }
                        });

                        const settings = {
                            entries,
                            width: parentWidth,
                            height: isMobile ? cloudSize + 100 : cloudSize,
                            radius: '100%',
                            radiusMin: 75,
                            bgDraw: false,
                            bgImage: "./image/word-cloud-bg.jpeg",
                            opacityOver: 1.0,
                            opacityOut: 0.05,
                            opacitySpeed: 6,
                            fov: 800,
                            speed: isMobile ? 0.2 : 0.3,
                            fontFamily: "Arial, sans-serif",
                            fontSize: isMobile ? 13 : 18,
                            fontColor: "#fff",
                            fontWeight: "bold",
                            fontStyle: "normal",
                            fontStretch: "normal",
                            fontToUpperCase: false,
                            onClick(systemName) {
                                const parsed = systemName.split("ã€Š")[0].trim();
                                window.displaySystemDetails(parsed, null,  null, true);
                            }
                        };

                        new SVG3DTagCloud(wordCloudElement, settings);
                    })
                    .catch(err => console.error("è®€å– system.json éŒ¯èª¤:", err));
        }

            // âœ… å…±ç”¨åˆ·æ–°æ–¹æ³•
        function reloadCloud(mode) {
                currentMode = mode;
                wordCloudElement.innerHTML = "";
                initializeWordCloud(mode);
        }
        // âœ… åˆå§‹è¼‰å…¥èˆ‡ resize
        initializeWordCloud(currentMode);
        window.addEventListener("resize", () => reloadCloud(currentMode));

        // âœ… ç¶å®šæ‰€æœ‰æ¨¡å¼æŒ‰éˆ•
        const modeButtons = {
                "btn-image-mode": "image",
                "btn-text-mode": "text",
                "btn-random-pick": "random"
        };
        Object.entries(modeButtons).forEach(([btnId, mode]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener("click", () => reloadCloud(mode));
                }
            });
        });

        const categorizedSystems = systemData.map(system => system.category); // æå–æ‰€æœ‰åˆ†é¡
        const Categories = [...new Set(categorizedSystems)];

        function generateCategoryButtons(categories) {
            const categoryContainer = document.getElementById("category-container");
            categoryContainer.innerHTML = '';

            categories.forEach(category => {
                const button = document.createElement("button");
                button.textContent = category;
                button.className = "category-button";

                button.addEventListener("click", () => {
                    ShowSystemStyleDescription(category);
                });

                categoryContainer.appendChild(button);
            });
        }  

        // é¡¯ç¤ºè©²åˆ†é¡çš„è©³ç´°ä»‹ç´¹èˆ‡ç³»çµ±åç¨±
        function displayCategoryDetails(category) {
            const systemsContainer = document.getElementById('SystemContent-container');
			systemsContainer.innerHTML = '';  // æ¸…ç©ºç¾æœ‰å…§å®¹
			debugger
            const categoryTitle = document.createElement("h3");
            categoryTitle.textContent = category.category;
            systemsContainer.appendChild(categoryTitle);

            const categoryDescription = document.createElement("p");
            categoryDescription.textContent = category.description;
            systemsContainer.appendChild(categoryDescription);

            const table = document.createElement('table');
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";

            category.forEach(system => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = system.system + "ã€Š" + system.system_EN + "ã€‹";
                cell.style.border = "1px solid #ddd";
                cell.style.padding = "10px";
                cell.style.textAlign = "center";
                row.appendChild(cell);
                table.appendChild(row);
            });

			systemsContainer.appendChild(table);
        }

        // å±•é–‹æˆ–æ”¶èµ·åˆ†é¡å…§å®¹
        function toggleCategoryContent(category) {
            const systemsContainer = document.getElementById('systems-container');
            const contentDiv = document.querySelector(`#systems-container h3:contains('${category}')`).parentElement;

            // å¦‚æœè©²åˆ†é¡å·²ç¶“é¡¯ç¤ºï¼Œå‰‡éš±è—å®ƒ
            if (contentDiv.style.display === "none") {
                contentDiv.style.display = "block";
            } else {
                contentDiv.style.display = "none";
            }
        }       

        function fadeTextChange(element, newText) {
            if (!element) return;
            element.classList.add('fade-out');
            // æ›æ–‡å­—ä¸¦æ·¡å…¥
            setTimeout(() => {
                element.innerHTML  = newText;
                element.classList.remove('fade-out');
            }, 300); 
		}       

        // åˆ‡æ›æ¨¡å¼æ¨£å¼
		function switchToMode(mode) {
			document.querySelectorAll(".explore-btn").forEach(btn => btn.classList.remove("active"));
			if (mode === "image") {
				document.getElementById("btn-image-mode").classList.add("active");
				// é€™è£¡åŠ ä¸Šåˆ‡æ›åœ–ç‰‡çš„é‚è¼¯
			} else {
				document.getElementById("btn-text-mode").classList.add("active");
				// é€™è£¡åŠ ä¸Šåˆ‡æ›æ–‡å­—çš„é‚è¼¯
			}
		}

       
	</script>

</body>
</html>
